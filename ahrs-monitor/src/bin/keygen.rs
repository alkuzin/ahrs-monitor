// SPDX-License-Identifier: Apache-2.0.
// Copyright (C) 2026-present ahrs-monitor project and contributors.

//! Keys & firmware config generating tool.

use ahrs_monitor::config;
use chrono::Local;
use rand::{Rng};
use std::{fs, path::Path};

/// Generate AES-128 & HMAC-SHA256 keys.
fn generate_keys() {
    let dir = Path::new("configs/firmware/secrets");
    let aes_path = dir.join("aes.key");
    let hmac_path = dir.join("hmac.key");

    fs::create_dir_all(dir).expect("Failed to create secrets directory");

    // Generating new keys.
    let mut aes_key = [0u8; 16];
    let mut hmac_key = [0u8; 32];
    let mut rng = rand::rng();

    rng.fill_bytes(&mut aes_key);
    rng.fill_bytes(&mut hmac_key);

    // Rewriting old keys.
    fs::write(&aes_path, aes_key).expect("Failed to write AES key");
    fs::write(&hmac_path, hmac_key).expect("Failed to write HMAC key");

    let now = Local::now().format("%m/%d/%Y %H:%M:%S").to_string();

    println!("Keys successfully updated in {dir:?} at {now}");
}

// struct ImuFirmwareConfig {
//
// }
//
// struct GatewayFirmwareConfig {
//
//     /// Flag whether to use encryption for IMU data transmission.
//     pub use_encryption: bool,
//
//     /// AHRS Monitor ingester's IP address.
//     pub const IP_ADDR: &str = "{}";
//
//     /// AHRS Monitor ingester's IP address.
//     pub const UDP_PORT: u16 = {};
//
//     /// AES-128 encryption key.
//     pub const AES_KEY: &[u8; 16] = include_bytes!("../../configs/firmware/secrets/aes.key");
//
// }


/// Generate config file for firmware based on AHRS Monitor configurations.
fn generate_config() {
    let dir = Path::new("configs/firmware/");
    let firmware_config_path = dir.join("firmware_config.rs");

    fs::create_dir_all(dir).expect("Failed to create firmware config file");

    let app_config = config::load_config(config::CONFIG_FILE_PATH);

    let firmware_config_text = format!(
        r#"// SPDX-License-Identifier: Apache-2.0.
// Copyright (C) 2026-present ahrs-monitor project and contributors.

//! Firmware configurations.
//! This module was generated by AHRS Monitor keygen software.
//! **DO NOT EDIT THIS FILE BY YOURSELF**. Use AHRS Monitor config for that.

/// Flag whether to use encryption for IMU data transmission.
pub const USE_ENCRYPTION: bool = {};

/// AHRS Monitor ingester's IP address.
pub const IP_ADDR: &str = "{}";

/// AHRS Monitor ingester's IP address.
pub const UDP_PORT: u16 = {};

/// AES-128 encryption key.
pub const AES_KEY: &[u8; 16] = include_bytes!("../../configs/firmware/secrets/aes.key");




/// HMAC-SHA256 key.
pub const HMAC_KEY: &[u8; 32] = include_bytes!("../../configs/firmware/secrets/hmac.key");

/// IMU sample rate in Hz.
pub const SAMPLE_RATE: u16 = {:.0};

/// IMU device identifier.
pub const DEVICE_ID: u16 = {};

/// IDTP protocol mode.
pub const IDTP_MODE: u8 = {};
        "#,
        app_config.net.use_encryption,
        app_config.net.ip_address,
        app_config.net.udp_port,
        app_config.imu.sample_rate,
        app_config.imu.device_id,
        app_config.imu.idtp_mode,
    );

    fs::write(&firmware_config_path, firmware_config_text)
        .expect("Failed to write firmware config file");

    println!(
        "Firmware config successfully updated in {firmware_config_path:?}"
    );
}

fn main() {
    println!("Running Keys & Config Generator");
    generate_keys();
    generate_config();
    println!("(Both firmware and AHRS Monitor MUST be recompiled)");
}
